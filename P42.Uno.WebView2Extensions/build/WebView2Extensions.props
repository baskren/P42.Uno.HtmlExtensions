<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <!-- You add this in your .csproj -->
    <!-- <WebView2ProjectContentFolder Include="MyWebAssets" /> -->
  </ItemGroup>


  <Target Condition="'@(WebView2ProjectContentFolder)' != ''" Name="P42_TransformWebView2ProjectContentFolders" BeforeTargets="BeforeBuild;UnoResourcesGeneration">

    <!--
    <ItemGroup>
      <_p42_webview2_file Include="$(MSBuildProjectDirectory)/%(WebView2ProjectContentFolder.Identity)/**/*.*">
        <Folder>%(WebView2ProjectContentFolder.Identity)</Folder>
      </_p42_webview2_file>
    </ItemGroup>

    <ItemGroup>
      <Content
        Condition=" $(TargetFramework.Contains('windows'))  "
        Include="@(_p42_webview2_file)"
        Link="WebView2ProjectContentFolders/%(_p42_webview2_file.Folder)/%(RecursiveDir)%(Filename)%(Extension)"
        CopyToOutputDirectory="PreserveNewest" />

    </ItemGroup>

  </Target>

  <Target Condition="'@(WebView2ProjectContentFolder)' != ''" Name="P42_TransformWebView2ProjectContentFolders" BeforeTargets="UnoResourcesGeneration">
  -->
    
    <ItemGroup>
      <_p42_webview2_file Include="$(MSBuildProjectDirectory)/%(WebView2ProjectContentFolder.Identity)/**/*.*">
        <Folder>%(WebView2ProjectContentFolder.Identity)</Folder>
      </_p42_webview2_file>
    </ItemGroup>

    <ItemGroup>
      <AndroidAsset
        Include="@(_p42_webview2_file)"
        Link="Platforms/Android/Assets/WebView2ProjectContentFolders/%(_p42_webview2_file.Folder)/%(RecursiveDir)%(Filename)%(Extension)" />

      <BundleResource
        Include="@(_p42_webview2_file)"
        Link="Platforms/iOS/Resources/WebView2ProjectContentFolders/%(_p42_webview2_file.Folder)/%(RecursiveDir)%(Filename)%(Extension)" />

      <Content
        Condition="  $(TargetFramework.Contains('windows'))  OR   $(TargetFramework.Contains('desktop'))  OR  $(TargetFramework.Contains('wasm')) "
        Include="@(_p42_webview2_file)"
        Link="WebView2ProjectContentFolders/%(_p42_webview2_file.Folder)/%(RecursiveDir)%(Filename)%(Extension)"
        CopyToOutputDirectory="PreserveNewest" />

    </ItemGroup>
    
    <!--
    <Message Text="  MSBuildProjectDirectory:[$(MSBuildProjectDirectory)]" Importance="high"/>
    <Message Text="  WebView2ProjectContentFolder:[%(WebView2ProjectContentFolder.Identity)]" Importance="high" />
    <Message Text="  _WebView2Root:[%(_WebView2Root.Identity)] [%(_WebView2Root.Folder)]" Importance="high"/>

      <Message
        Condition=" $(TargetFramework.Contains('android')) "
        Text="AndroidAsset: ID[%(AndroidAsset.Identity)]     LINK[%(AndroidAsset.Link)]"
        Importance="High" />
      <Message
        Condition=" $(TargetFramework.Contains('ios'))"
        Text="BundleResource: ID[%(BundleResource.Identity)]     LINK[%(BundleResource.Link)]"
        Importance="High" />
      <Message
        Condition=" $(TargetFramework.Contains('windows'))  OR  $(TargetFramework.Contains('desktop'))  OR  $(TargetFramework.Contains('wasm')) "
        Text="W Content: ID[%(Content.Identity)]     LINK[%(Content.Link)]"
        Importance="High" />
  -->

  </Target>

  <!-- Path to generated file -->
  <PropertyGroup>
    <WebView2ExtensionsGeneratedCodeFile>$(IntermediateOutputPath)App.GeneratedWebView2.g.cs</WebView2ExtensionsGeneratedCodeFile>
  </PropertyGroup>

  
  <!-- App.cs or App.xaml.cs NameSpace -->
  <Choose>
    <When Condition=" '$(AppNamespace)' != '' and '$(AppNamespace.Trim())' != '' ">
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(AppNamespace)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </When>
    <When Condition=" '$(RootNamespace)' != '' and '$(RootNamespace.Trim())' != '' ">
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(RootNamespace)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(ApplicationTitle)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </Otherwise>
  </Choose>


  <Target Name="GenerateWebView2RegistrationCode"
          BeforeTargets="BeforeCompile">

    <!-- Create the file -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="/* Auto-generated file : DO NOT EDIT */"
        Overwrite="true" />

    <!-- Namespace -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="namespace $(WebView2ExtensionsGeneratedCodeFileNameSpace)%3B"
        Overwrite="false" />

    <!-- Class Entry -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="public partial class App : P42.Uno.IWebView2ProjectContent;{"
        Overwrite="false" />

    <!-- Method Entry -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09public void RegisterProjectProvidedItems();%09{"
        Overwrite="false" />

    <!-- For each item, add a function call -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09%09P42.Uno.WebView2Extensions.EnableProjectContentFolder(@&quot;%(WebView2ProjectContentFolder.Identity)&quot;)%3B"
        Overwrite="false" />

    <!-- Method Exit -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09}"
        Overwrite="false" />

    <!-- Class Exit -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="}"
        Overwrite="false" />

    <!-- Add the generated file into Compile items -->
    <ItemGroup>
      <Compile Include="$(WebView2ExtensionsGeneratedCodeFile)" />
    </ItemGroup>

  </Target>


</Project>
