<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Path to generated file -->
  <PropertyGroup>
    <WebView2ExtensionsGeneratedCodeFile>$(BaseIntermediateOutputPath)App.GeneratedWebView2.g.cs</WebView2ExtensionsGeneratedCodeFile>
  </PropertyGroup>

  <!-- App.cs or App.xaml.cs NameSpace -->
  <Choose>
    <When Condition=" '$(AppXamlCsNamespace)' != '' and '$(AppXamlCsNamespace.Trim())' != '' ">
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(AppXamlCsNamespace)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </When>
    <When Condition=" '$(RootNamespace)' != '' and '$(RootNamespace.Trim())' != '' ">
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(RootNamespace)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <WebView2ExtensionsGeneratedCodeFileNameSpace>$(ApplicationTitle)</WebView2ExtensionsGeneratedCodeFileNameSpace>
      </PropertyGroup>
    </Otherwise>
  </Choose>


  <Target Name="P42_GenerateWebView2RegistrationCode"
          AfterTargets="PrepareForBuild"
          Condition="   $(OutputType) != 'Library' AND  '@(WebView2ProjectContentFile)' != ''"
          >

  <ItemGroup>

    <WebView2ProjectContentFile Include="@(WebView2ProjectContentFile)">
      <CSharpRelativeDir>$([System.String]::Copy('%(RelativeDir)').Replace('\','/').Split('/')[0])</CSharpRelativeDir>
    </WebView2ProjectContentFile>

    <UniqueWebView2ProjectContentRootFolders Include="@(WebView2ProjectContentFile->Metadata('CSharpRelativeDir')->Distinct())"/>

  </ItemGroup>

    <Message
      Text="ProjectContentFile: ID[%(WebView2ProjectContentFile.Identity)] LINK[%(WebView2ProjectContentFile.Link)] FOLDER[%(WebView2ProjectContentFile.CSharpRelativeDir)]"
      Importance="high"
      />



    <Message Text=" AppXamlCsNamespace: $(AppXamlCsNamespace)" Importance="high"/>
    <Message Text=" AppXamlCsNamespace.Trim(): $(AppXamlCsNamespace.Trim())" Importance="high"/>
    <Message Text=" RootNamespace: $(RootNamespace)" Importance="high"/>
    <Message Text=" RootNamespace.Trim(): $(RootNamespace.Trim())" Importance="high"/>
    <Message Text=" ApplicationTitle: $(ApplicationTitle)" Importance="high"/>
    <Message Text=" ApplicationTitle.Trim(): $(ApplicationTitle.Trim())" Importance="high"/>

    <!-- Create the file -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="/* Auto-generated file : DO NOT EDIT */"
        Overwrite="true" />

    <!-- Namespace -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="namespace $(WebView2ExtensionsGeneratedCodeFileNameSpace)%3B"
        Overwrite="false" />

    <!-- Class Entry -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="public partial class App : P42.Uno.IWebView2ProjectContent;{"
        Overwrite="false" />

    
    <!-- Method Entry -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09public void RegisterProjectProvidedItems();%09{"
        Overwrite="false" />

    <!-- For each item, add a function call -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09%09P42.Uno.WebView2Extensions.EnableProjectContentFolder(&quot;%(UniqueWebView2ProjectContentRootFolders.Identity)&quot;)%3B"
        Overwrite="false" />


    <!-- Method Exit -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="%09}"
        Overwrite="false" />

    <!-- Class Exit -->
    <WriteLinesToFile
        File="$(WebView2ExtensionsGeneratedCodeFile)"
        Lines="}"
        Overwrite="false" />

    <!-- Add the generated file into Compile items -->
    <ItemGroup>
      <Compile Include="$(WebView2ExtensionsGeneratedCodeFile)" />
    </ItemGroup>

  </Target>


</Project>
