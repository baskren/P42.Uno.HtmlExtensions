<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Render ./document.md</title>
    <link rel="stylesheet" href="github.min.css">
    <link rel="stylesheet" href="bootstrap.css">

    <link rel="stylesheet" href="katex/katex.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="texmath.css">

    <style>
        :root {
            --maxw: 900px;
            --pad: 20px;
            --muted: #6b7280
        }

        body {
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
            line-height: 1.6;
            margin: 0;
            background: #f8fafc;
            color: #0f172a
        }

        .container {
            max-width: var(--maxw);
            margin: 32px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(2,6,23,0.08);
            overflow: hidden
        }

        header {
            padding: var(--pad);
            border-bottom: 1px solid #eef2f7
        }

            header h1 {
                margin: 0;
                font-size: 1.1rem
            }

            header p {
                margin: 6px 0 0;
                color: var(--muted);
                font-size: 0.9rem
            }

        main {
            padding: var(--pad)
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            background: #fffbeb;
            color: #92400e;
            margin-bottom: 12px
        }

        pre {
            overflow: auto;
            padding: 12px;
            border-radius: 8px;
            background: #0b1220;
            color: #e6eef8
        }

        a.small {
            font-size: 0.9rem;
            color: #0366d6
        }

        table {
            border-collapse: collapse;
            margin: 1em 0;
            width: 100%
        }

        th, td {
            border: 1px solid #d1d5db;
            padding: 6px 10px;
            text-align: left
        }

        th {
            background: #f3f4f6
        }

        sub {
            font-size: 0.8em;
            vertical-align: sub
        }

        sup {
            font-size: 0.8em;
            vertical-align: super
        }

        .footnotes {
            border-top: 1px solid #e5e7eb;
            margin-top: 2em;
            padding-top: 1em;
            font-size: 0.9em;
            color: var(--muted)
        }

        abbr[title] {
            border-bottom: 1px dotted;
            cursor: help
        }

        mark {
            background: #fef08a;
            padding: 0 2px;
            border-radius: 2px
        }

        ins {
            text-decoration: none;
            background: #d1fae5;
            padding: 0 2px;
            border-radius: 2px
        }

        .custom-block {
            border-left: 4px solid #3b82f6;
            background: #eff6ff;
            padding: 10px 14px;
            margin: 1em 0;
            border-radius: 6px
        }

        dl {
            margin: 1em 0
        }

        dt {
            font-weight: bold;
            margin-top: 0.5em
        }

        dd {
            margin: 0 0 0.5em 1.5em;
            color: #374151
        }
    </style>
</head>
<body>
    <main>
        <div id="status" class="status" style="display:none"></div>
        <article id="content">Loading…</article>
    </main>


    <!-- markdown-it core and plugins -->
    <script src="markdown-it.min.js"></script>
    <script src="markdown-it-sub.min.js"></script>
    <script src="markdown-it-sup.min.js"></script>
    <script src="markdown-it-footnote.min.js"></script>
    <script src="markdown-it-emoji.min.js"></script>
    <script src="markdown-it-abbr.min.js"></script>
    <script src="markdown-it-mark.min.js"></script>
    <script src="markdown-it-ins.min.js"></script>
    <script src="markdown-it-container.min.js"></script>
    <script src="markdown-it-deflist.min.js"></script>
    <script src="katex/katex.min.js"></script>
    <script src="katex/contrib/auto-renderer.min.js" onload="renderMathInElement(document.body);"></script>
    <script src="markdown-it-texmath.min.js"></script>

    <script>
        // configure markdown-it with plugins
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (window.hljs && lang && hljs.getLanguage(lang)) {
                    try { return '<pre><code class="hljs">' + hljs.highlight(str, { language: lang, ignoreIllegals: true }).value + '</code></pre>'; }
                    catch (__) { }
                }
                return '<pre><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        })
            .use(window.markdownitSub)
            .use(window.markdownitSup)
            .use(window.markdownitFootnote)
            .use(window.markdownitEmoji)
            .use(window.markdownitAbbr)
            .use(window.markdownitMark)
            .use(window.markdownitIns)
            .use(window.markdownitDeflist)
            .use(texmath.use(katex), { delimiters: 'dollars' })
            /*
            .use(window.markdownitTexmath, {
                engine: katex,
                delimiters: 'dollars',
                katexOptions: { macros: { "\\RR": "\\mathbb{R}" } }
            })
            */
            .use(window.markdownitContainer, 'custom', {
                render: function (tokens, idx) {
                    if (tokens[idx].nesting === 1) {
                        return '<div class="custom-block">';
                    } else {
                        return '</div>';
                    }
                }
            });

        const statusEl = document.getElementById('status');
        const contentEl = document.getElementById('content');

        function showStatus(text, isError) {
            statusEl.style.display = 'block';
            statusEl.textContent = text;
            statusEl.style.background = isError ? '#fff1f2' : '#fffbeb';
            statusEl.style.color = isError ? '#991b1b' : '#92400e';
        }

        function missingParameter(argName, value) {
            if (!value || value === '') {
                const msg = `[${window.location.href}]: no '${argName}' parameter provided`;
                contentEl.innerHTML = '<pre>${msg}</pre>';
                showStatus(msg, true);
                console.error(msg);
                return true;
            }
            return false;
        }

        async function loadMarkdown() {
            const params = new URLSearchParams(window.location.search);

            const dir = params.get("dir");
            const filename = params.get("filename");
            const query = params.get("query");
            //console.log("dir: "+dir);
            //console.log("filename: "+filename);
            //console.log("query: "+query);

            //var reqUrl = params.get("requestUrl");

            if (missingParameter('dir', dir) || missingParameter('filename', filename))
                return;

            const newBaseUrl = `${dir}/`;
            //console.log("newBaseUrl: "+newBaseUrl);
            const newBase = document.createElement('base');
            newBase.setAttribute('href', newBaseUrl);
            document.head.appendChild(newBase);

            let fetchUrl = filename;
            if (typeof query === 'string' && query !== '') {
                fetchUrl = `${filename}&${query}`;
            }
            console.log("fetchUrl: " + fetchUrl);

            try {
                const res = await fetch(fetchUrl, { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
                const mdText = await res.text();
                contentEl.innerHTML = md.render(mdText);
                if (window.hljs && typeof hljs.highlightAll === 'function') hljs.highlightAll();
                statusEl.style.display = 'none';
            } catch (err) {
                contentEl.innerHTML = '<pre>' + String(err) + '</pre>';
                showStatus(`[${window.location.href}]: Could not load [${fetchUrl}] — see message below.`, true);
                console.error(err);
            }
        }

        loadMarkdown();
    </script>
</body>
</html>
